<html>
  <head>
    <style>
      html {
        max-width: 70ch;
        padding: 3em 1em;
        margin: auto;
        line-height: 1.75;
        font-size: 1.25em;
        font-family: sans-serif;
      }
    
      h1,h2,h3,h4,h5,h6 {
        margin: 3em 0 1em;
      }
    
      p,ul,ol {
        margin-bottom: 2em;
      }
    
      img {
        width: 100%;
      }
    
      .icon {
        float: left;
        margin-right: 1em;
        width: 3em;
        height: 3em;
      }
    
      pre {
        overflow-x:auto;
        font-size:0.8em;
      }
    
      footer {
        font-size: small;
      }
    
    </style>    
  </head>
  <body>
    <header>
      <h1>Deploy Gemma 3 to Cloud Run</h1>
      <p>
        A <b>client-side</b> webapp to deploy <a href="https://blog.google/technology/developers/gemma-3/">Gemma 3</a> to <a href="https://cloud.google.com/run">Google Cloud Run</a> using <a href="https://ollama.com/library/gemma3">Ollama</a>.
      </p>
    </header>
    <main>
      <ol>
        <li><button onclick="oauth2SignIn();">Sign in with Google</button></li>
        <li><button onclick="deploy();">Deploy to Cloud Run</button></li>
      </ol>
    </main>
    <footer>
      <p>
        <b>This is not an official Google product.</b> Use it at your own risk.<br>
        The deployment is done from your browser to your Google Cloud project, no server involved.<br>
        Built by <a href="https://steren.fr">Steren</a> (<a href="https://github.com/steren/deploy-gemma">source code</a>).
      </p>
    </footer>

    <script type="module">
      const CLIENT_ID = '607903476290-nkeuoe6ojl8oq1f6cgb9rtervt4chao2.apps.googleusercontent.com';
      const REDIRECT_URI = window.location.origin;

      // Parse query string to see if page request is coming from OAuth 2.0 server.
      var fragmentString = location.hash.substring(1);
      var params = {};
      var regex = /([^&=]+)=([^&]*)/g, m;
      while (m = regex.exec(fragmentString)) {
        params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
      }
      if (Object.keys(params).length > 0 && params['state']) {
        if (params['state'] == localStorage.getItem('state')) {
          
          localStorage.setItem('oauth2-params', JSON.stringify(params) );

          localStorage.setItem('token', params['access_token']);

          console.log('Credential received and stored');
        } else {
          console.log('State mismatch. Possible CSRF attack');
        }
      }

      // Function to generate a random state value
      function generateCryptoRandomState() {
        const randomValues = new Uint32Array(2);
        window.crypto.getRandomValues(randomValues);

        // Encode as UTF-8
        const utf8Encoder = new TextEncoder();
        const utf8Array = utf8Encoder.encode(
          String.fromCharCode.apply(null, randomValues)
        );

        // Base64 encode the UTF-8 data
        return btoa(String.fromCharCode.apply(null, utf8Array))
          .replace(/\+/g, '-')
          .replace(/\//g, '_')
          .replace(/=+$/, '');
      }

      function getCloudRunServicePayload(image) {
        return {
          launchStage: 'BETA',
          client: 'web-app-deploy-gemma',
          template: {
            containers: [{image}],
          },
        };
      }

      async function deploy() {

        var token = localStorage.getItem('token');
        if (!token) {
          console.error('No access token. Get one by signing in.');
          return;
        }

        let project = 'steren-playground';
        let region = 'us-central1';
        let service = 'hello-from-web';
        let image = 'gcr.io/cloudrun/hello';

        console.log(`Deploying to Cloud Run: ${project} ${region} ${service} ${image}`);

        var response = await fetch(`https://${region}-run.googleapis.com/v2/projects/${project}/locations/${region}/services?serviceId=${service}`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(getCloudRunServicePayload(image))
        });

        var result = await response.json();
        console.log(result);

      }

      /*
        * Create form to request access token from Google's OAuth 2.0 server.
        */
      function oauth2SignIn() {
        // create random state value and store in local storage
        var state = generateCryptoRandomState();
        localStorage.setItem('state', state);

        // Google's OAuth 2.0 endpoint for requesting an access token
        var oauth2Endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';

        // Create element to open OAuth 2.0 endpoint in new window.
        var form = document.createElement('form');
        form.setAttribute('method', 'GET'); // Send as a GET request.
        form.setAttribute('action', oauth2Endpoint);

        // Parameters to pass to OAuth 2.0 endpoint.
        var params = {'client_id': CLIENT_ID,
                      'redirect_uri': REDIRECT_URI,
                      'scope': 'https://www.googleapis.com/auth/cloud-platform',
                      'state': state,
                      'include_granted_scopes': 'true',
                      'response_type': 'token'};

        // Add form parameters as hidden input values.
        for (var p in params) {
          var input = document.createElement('input');
          input.setAttribute('type', 'hidden');
          input.setAttribute('name', p);
          input.setAttribute('value', params[p]);
          form.appendChild(input);
        }

        // Add form to page and submit it to open the OAuth 2.0 endpoint.
        document.body.appendChild(form);
        form.submit();
      }
    </script>
  </body>
</html>